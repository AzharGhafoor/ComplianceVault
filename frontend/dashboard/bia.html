<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Impact Analysis - ComplianceVault</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        /* Layout */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 100;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: var(--accent-gradient);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }

        .nav-section {
            padding: 0.5rem 1rem;
            margin-top: 0.5rem;
        }

        .nav-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            margin: 0.25rem 0.5rem;
            transition: all var(--transition-fast);
        }

        .nav-link:hover {
            background: var(--bg-glass);
            color: var(--text-primary);
        }

        .nav-link.active {
            background: var(--accent-gradient);
            color: white;
        }

        .nav-link svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--accent-gradient);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
        }

        .user-details {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: capitalize;
        }

        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 2rem;
        }

        .page-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .page-title {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--text-secondary);
        }

        /* BIA Specific */
        .impact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .impact-input-group {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: var(--radius-md);
        }

        .rating-matrix {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
        }

        .matrix-cell {
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        .matrix-cell.selected {
            border-color: var(--primary-color);
            background: rgba(var(--primary-rgb), 0.1);
        }

        .security-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .security-high {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .security-medium {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .security-low {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Tailwind Shim */
        .grid {
            display: grid;
        }

        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        @media (min-width: 768px) {
            .md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (min-width: 1024px) {
            .lg\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        .gap-3 {
            gap: 0.75rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .gap-6 {
            gap: 1.5rem;
        }

        .col-span-full {
            grid-column: 1 / -1;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .justify-between {
            justify-content: space-between;
        }

        .justify-center {
            justify-content: center;
        }

        .items-center {
            align-items: center;
        }

        .items-start {
            align-items: flex-start;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mb-8 {
            margin-bottom: 2rem;
        }

        .mt-6 {
            margin-top: 1.5rem;
        }

        .py-12 {
            padding-top: 3rem;
            padding-bottom: 3rem;
        }

        .px-3 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        .py-1 {
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }

        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .text-center {
            text-align: center;
        }

        .text-left {
            text-align: left;
        }

        .text-xl {
            font-size: 1.25rem;
            line-height: 1.75rem;
        }

        .text-2xl {
            font-size: 1.5rem;
            line-height: 2rem;
        }

        .text-3xl {
            font-size: 1.875rem;
            line-height: 2.25rem;
        }

        .text-4xl {
            font-size: 2.25rem;
            line-height: 2.5rem;
        }

        .text-lg {
            font-size: 1.125rem;
            line-height: 1.75rem;
        }

        .text-sm {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }

        .text-xs {
            font-size: 0.75rem;
            line-height: 1rem;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-bold {
            font-weight: 700;
        }

        .font-medium {
            font-weight: 500;
        }

        .font-mono {
            font-family: monospace;
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        .text-red-500 {
            color: #ef4444;
        }

        .text-orange-500 {
            color: #f97316;
        }

        .text-green-500 {
            color: #22c55e;
        }

        .bg-white\/5 {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .bg-red-500\/20 {
            background-color: rgba(239, 68, 68, 0.2);
        }

        .border {
            border-width: 1px;
            border-style: solid;
            box-sizing: border-box;
        }

        .border-white\/10 {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .border-white\/5 {
            border-color: rgba(255, 255, 255, 0.05);
        }

        .border-red-500\/30 {
            border-color: rgba(239, 68, 68, 0.3);
        }

        .border-b {
            border-bottom-width: 1px;
        }

        .rounded {
            border-radius: 0.25rem;
        }

        .w-full {
            width: 100%;
        }

        .overflow-x-auto {
            overflow-x: auto;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .transition-colors {
            transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
        }

        .info-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 10px;
            margin-left: 6px;
            border: 1px solid var(--border-color);
        }

        .tooltip-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: help;
        }

        .tooltip-wrapper:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e1e1e;
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 4px;
            width: 220px;
            font-size: 0.75rem;
            color: #fff;
            z-index: 1000;
            pointer-events: none;
            margin-bottom: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            text-align: center;
            line-height: 1.4;
            white-space: normal;
        }

        .form-range {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }

        .form-range:hover {
            opacity: 1;
        }

        .form-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        .form-range::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        /* Enhanced scrollbar for modal */
        .modal-body::-webkit-scrollbar {
            width: 12px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 10px;
            border: 2px solid var(--bg-secondary);
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/" class="sidebar-logo">
                    <div class="logo-icon">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
                        </svg>
                    </div>
                    <span class="text-gradient">ComplianceVault</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Overview</div>
                    <a href="index.html" class="nav-link">
                        <svg viewBox="0 0 24 24">
                            <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                            <polyline points="9 22 9 12 15 12 15 22" />
                        </svg>
                        Dashboard
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Assessment</div>
                    <a href="assessment.html" class="nav-link">
                        <svg viewBox="0 0 24 24">
                            <path d="M9 11l3 3L22 4" />
                            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" />
                        </svg>
                        Controls
                    </a>
                    <a href="domains.html" class="nav-link">
                        <svg viewBox="0 0 24 24">
                            <rect x="3" y="3" width="7" height="7" />
                            <rect x="14" y="3" width="7" height="7" />
                            <rect x="14" y="14" width="7" height="7" />
                            <rect x="3" y="14" width="7" height="7" />
                        </svg>
                        Domains
                    </a>
                    <a href="bia.html" class="nav-link active" id="navBia">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="12 2 2 7 12 12 22 7 12 2" />
                            <polyline points="2 17 12 22 22 17" />
                            <polyline points="2 12 12 17 22 12" />
                        </svg>
                        Business Impact
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                    <a href="history.html" class="nav-link">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" />
                            <polyline points="12 6 12 12 16 14" />
                        </svg>
                        Change Log
                    </a>
                    <a href="users.html" class="nav-link" id="navTeam">
                        <svg viewBox="0 0 24 24">
                            <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M23 21v-2a4 4 0 00-3-3.87" />
                            <path d="M16 3.13a4 4 0 010 7.75" />
                        </svg>
                        Team
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Loading...</div>
                        <div class="user-role" id="userRole">-</div>
                    </div>
                    <button class="btn btn-icon btn-ghost" id="logoutBtn" title="Logout">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4" />
                            <polyline points="16 17 21 12 16 7" />
                            <line x1="21" y1="12" x2="9" y2="12" />
                        </svg>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Business Impact Analysis</h1>
                    <p class="page-subtitle">Assess process criticality and classify information assets</p>
                </div>
                <div class="flex gap-3">
                    <button class="btn btn-secondary" onclick="openSettings()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="3" />
                            <path
                                d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" />
                        </svg>
                        Weight Settings
                    </button>
                    <button class="btn btn-primary" onclick="openProcessModal()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <line x1="5" y1="12" x2="19" y2="12" />
                        </svg>
                        Add Process
                    </button>
                </div>
            </div>

            <!-- Methodology Section -->
            <div class="glass-card mb-6">
                <details>
                    <summary class="flex justify-between items-center cursor-pointer list-none">
                        <h2 class="text-xl font-semibold">BIA Methodology & Scoring</h2>
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" class="transform transition-transform duration-200">
                            <path d="M6 9l6 6 6-6" />
                        </svg>
                    </summary>
                    <div class="mt-4 pt-4 border-t border-white/10 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Process Criticality -->
                            <div>
                                <h3 class="font-medium text-lg mb-2 text-primary">3. Process Criticality Score</h3>
                                <p class="text-sm text-secondary mb-2">Processes rated on 5 factors (each 0-4), weighted
                                    by importance (0-4):</p>
                                <ul class="list-disc pl-5 text-sm text-secondary space-y-1">
                                    <li>Reputation, External, Internal, Legal, Economic</li>
                                </ul>
                                <div class="mt-3 bg-white/5 p-3 rounded font-mono text-xs">
                                    Criticality = 1.25 Ã— Î£(w<sub>i</sub> Ã— I<sub>i</sub>)<br>
                                    <span class="text-xs opacity-75">Range: 0-100</span>
                                </div>
                            </div>

                            <!-- Security Levels -->
                            <div>
                                <h3 class="font-medium text-lg mb-2 text-primary">1. Asset Classification (CIA)</h3>
                                <p class="text-sm text-secondary mb-2">Each asset is rated on three dimensions (NIA
                                    Policy v2.0):</p>
                                <ul class="list-disc pl-5 text-sm text-secondary space-y-1">
                                    <li><strong>Confidentiality (C 0-3)</strong>: Public, Internal, Limited Access,
                                        Restricted</li>
                                    <li><strong>Integrity (I 0-3)</strong>: Not Important, Identifiable, Checked,
                                        Provable</li>
                                    <li><strong>Availability (A 0-3)</strong>: Not Important, 90%, 99%, 99.9%</li>
                                </ul>
                                <div class="mt-3 bg-white/5 p-3 rounded font-mono text-xs">
                                    Security Level = Max(C, I, A)
                                </div>
                            </div>

                            <!-- Weighting -->
                            <div>
                                <h3 class="font-medium text-lg mb-2 text-primary">2. Aggregate Security Level</h3>
                                <p class="text-sm text-secondary mb-2">Based on the highest C/I/A rating:</p>
                                <div class="space-y-2 mt-2">
                                    <div class="flex items-center gap-2">
                                        <span class="security-badge security-low w-16 text-center">Low</span>
                                        <span class="text-xs text-secondary">Max(C,I,A) â‰¤ 1 â†’ Baseline Controls</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="security-badge security-medium w-16 text-center">Medium</span>
                                        <span class="text-xs text-secondary">Max(C,I,A) = 2 â†’ Baseline + 1+</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="security-badge security-high w-16 text-center">High</span>
                                        <span class="text-xs text-secondary">Max(C,I,A) â‰¥ 3 â†’ Baseline + 2+</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Weighting -->
                            <div>
                                <h3 class="font-medium text-lg mb-2 text-primary">3. Impact Weighting</h3>
                                <p class="text-sm text-secondary">
                                    Business processes are weighted based on their criticality to the organization.
                                    These weights amplify the impact of associated assets, ensuring that critical
                                    business
                                    functions are prioritized in the risk assessment.
                                </p>
                                <button class="btn btn-sm btn-secondary mt-3 w-full" onclick="openSettings()">
                                    Configure Impact Weights
                                </button>
                            </div>
                        </div>
                    </div>
                </details>
            </div>

            <!-- Compliance Level Card -->
            <div class="glass-card mb-8">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-xl font-semibold mb-2">Aggregate Security Level</h2>
                        <p class="text-secondary text-sm mb-4">Determined by the highest classification level across all
                            information assets.</p>
                        <div class="flex items-center gap-4">
                            <div class="text-4xl font-bold" id="aggLevel">-</div>
                            <div class="text-sm px-3 py-1 rounded bg-white/5 border border-white/10" id="aggControls">
                                Required Controls: -</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processes List -->
            <div id="processesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Process Cards will be injected here -->
                <div class="col-span-full text-center py-12 text-secondary">Loading processes...</div>
            </div>
        </main>
    </div>

    <!-- Process Modal -->
    <div class="modal-backdrop" id="processModal">
        <div class="modal" style="max-width: 800px">
            <div class="modal-header">
                <h3 id="processModalTitle">Add Business Process</h3>
                <button class="btn-icon" onclick="closeProcessModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="processId">
                <div class="form-group">
                    <label class="form-label">Process Name <span style="color: #ef4444;">*</span></label>
                    <input type="text" id="processName" class="form-input" placeholder="e.g., Payroll Processing"
                        required>
                </div>
                <div class="form-group">
                    <label class="form-label">Process Owner <span style="color: #ef4444;">*</span></label>
                    <input type="text" id="processOwner" class="form-input" placeholder="e.g., HR Director" required>
                </div>

                <h4 class="text-lg font-medium mt-6 mb-4">Impact Assessment (0-4) - NIA Policy v2.0</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="impact-input-group">
                        <label class="form-label tooltip-wrapper"
                            data-tooltip="Damage to public image, brand trust, and stakeholder confidence.">
                            Reputation Impact <span class="info-icon">?</span>
                        </label>
                        <select id="impRep" class="form-input">
                            <option value="0">0 - None</option>
                            <option value="1">1 - Low</option>
                            <option value="2">2 - Medium</option>
                            <option value="3">3 - High</option>
                            <option value="4">4 - Very High</option>
                        </select>
                    </div>
                    <div class="impact-input-group">
                        <label class="form-label tooltip-wrapper"
                            data-tooltip="Impact on external parties such as citizens, customers, partners, or third-party providers.">
                            External Impact <span class="info-icon">?</span>
                        </label>
                        <select id="impExt" class="form-input">
                            <option value="0">0 - None</option>
                            <option value="1">1 - Low</option>
                            <option value="2">2 - Medium</option>
                            <option value="3">3 - High</option>
                            <option value="4">4 - Very High</option>
                        </select>
                    </div>
                    <div class="impact-input-group">
                        <label class="form-label tooltip-wrapper"
                            data-tooltip="Disruption to internal operations, staff productivity, or mission-critical functions.">
                            Internal Impact <span class="info-icon">?</span>
                        </label>
                        <select id="impInt" class="form-input">
                            <option value="0">0 - None</option>
                            <option value="1">1 - Low</option>
                            <option value="2">2 - Medium</option>
                            <option value="3">3 - High</option>
                            <option value="4">4 - Very High</option>
                        </select>
                    </div>
                    <div class="impact-input-group">
                        <label class="form-label tooltip-wrapper"
                            data-tooltip="Exposure to legal liability, regulatory fines, or compliance violations.">
                            Legal Impact <span class="info-icon">?</span>
                        </label>
                        <select id="impLeg" class="form-input">
                            <option value="0">0 - None</option>
                            <option value="1">1 - Low</option>
                            <option value="2">2 - Medium</option>
                            <option value="3">3 - High</option>
                            <option value="4">4 - Very High</option>
                        </select>
                    </div>
                    <div class="impact-input-group">
                        <label class="form-label tooltip-wrapper"
                            data-tooltip="Direct financial loss, lost revenue, or cost of recovery assets.">
                            Economic Impact <span class="info-icon">?</span>
                        </label>
                        <select id="impEco" class="form-input">
                            <option value="0">0 - None</option>
                            <option value="1">1 - Low</option>
                            <option value="2">2 - Medium</option>
                            <option value="3">3 - High</option>
                            <option value="4">4 - Very High</option>
                        </select>
                    </div>
                    <div class="impact-input-group flex flex-col justify-center items-center bg-white/5">
                        <div class="text-sm text-secondary">Criticality Score</div>
                        <div class="text-3xl font-bold" id="criticalityScoreDisplay">0</div>
                    </div>
                </div>

                <div id="assetSection" class="hidden">
                    <h4 class="text-lg font-medium mt-6 mb-4 flex justify-between">
                        Information Assets
                        <button class="btn btn-sm btn-secondary" onclick="openAssetForm()">Add Asset</button>
                    </h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left" style="border-collapse: collapse;">
                            <thead>
                                <tr class="text-secondary text-sm border-b border-white/10">
                                    <th class="py-2">Asset Name</th>
                                    <th class="py-2">Type</th>
                                    <th class="py-2">C / I / A</th>
                                    <th class="py-2">Level</th>
                                    <th class="py-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="assetsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: space-between">
                <button class="btn btn-sm text-red-400 hover:text-red-300" id="btnDeleteProcess"
                    onclick="deleteCurrentProcess()" style="display:none">
                    Delete Process
                </button>
                <div class="flex gap-2">
                    <button class="btn btn-secondary" onclick="closeProcessModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveProcess()">Save Process</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Asset Modal (Nested or separate) -->
    <div class="modal-backdrop" id="assetModal" style="background: rgba(0,0,0,0.8); z-index: 1100;">
        <div class="modal" style="max-width: 500px">
            <div class="modal-header">
                <h3>Add Information Asset</h3>
                <button class="btn-icon" onclick="closeAssetModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="assetId">
                <div class="form-group">
                    <label class="form-label">Asset Name</label>
                    <input type="text" id="assetName" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select id="assetType" class="form-input">
                        <option value="Data">Data</option>
                        <option value="Software">Software</option>
                        <option value="Hardware">Hardware</option>
                        <option value="People">People</option>
                        <option value="Services">Services</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Confidentiality (0-3) - NIA Policy v2.0</label>
                    <input type="range" id="ratingC" min="0" max="3" value="0" class="w-full"
                        oninput="updateCLabel(this.value)">
                    <span id="lblC" class="text-sm text-secondary">C0 - Public</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Integrity (0-3)</label>
                    <input type="range" id="ratingI" min="0" max="3" value="0" class="w-full"
                        oninput="updateLabel('lblI', this.value)">
                    <span id="lblI" class="text-sm text-secondary">0 - Not Important</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Availability (0-3)</label>
                    <input type="range" id="ratingA" min="0" max="3" value="0" class="w-full"
                        oninput="updateLabel('lblA', this.value)">
                    <span id="lblA" class="text-sm text-secondary">0 - Not Important</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAssetModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveAsset()">Save Asset</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-backdrop" id="settingsModal">
        <div class="modal" style="max-width: 600px">
            <div class="modal-header">
                <div>
                    <h3>Criticality Weight Configuration</h3>
                    <p class="text-sm text-secondary mt-1">Adjust how much each impact factor contributes to the overall
                        process criticality score.</p>
                </div>
                <button class="btn-icon" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding-right: 0.5rem;">
                <div
                    style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--accent-primary); border-radius: 0.5rem;">
                    <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6;">
                        <strong style="color: var(--text-primary);">Impact weights</strong> allow you to prioritize
                        different types of organizational impact.
                        Higher weights (up to 5x) amplify a factor's contribution to the overall criticality score.
                        Lower weights (down to 0.1x) reduce its importance. Use <strong>1.0x</strong> as the baseline
                        for equal importance.
                    </p>
                </div>

                <!-- Reputation -->
                <div
                    style="background: rgba(255,255,255,0.05); padding: 1.25rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; font-size: 1rem;">Reputation Impact</label>
                        <span style="color: var(--accent-primary); font-weight: 700; font-size: 1.125rem;"
                            id="valRep">1.0x</span>
                    </div>
                    <p
                        style="font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 0.75rem; line-height: 1.5;">
                        Weight applied to <strong>brand damage, public trust erosion, and stakeholder
                            confidence</strong>.
                        High reputation impact can affect customer loyalty, investor confidence, and market position.
                    </p>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem; font-style: italic;">
                        ðŸ’¡ Example: Set to 2.0x or higher if your organization relies heavily on public trust (e.g.,
                        healthcare, finance).
                    </p>
                    <input type="range" id="weightRep" min="0" max="4" step="1" value="1" class="w-full form-range"
                        oninput="document.getElementById('valRep').textContent = this.value">
                    <div style="display: flex; justify-content: space-between; margin-top: 0.25rem;">
                        <span style="font-size: 0.7rem; color: var(--text-muted);">Low (0.1x)</span>
                        <span style="font-size: 0.7rem; color: var(--text-muted);">High (5.0x)</span>
                    </div>
                </div>

                <!-- External -->
                <div
                    style="background: rgba(255,255,255,0.05); padding: 1.25rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; font-size: 1rem;">External Impact</label>
                        <span style="color: var(--accent-primary); font-weight: 700; font-size: 1.125rem;"
                            id="valExt">1.0x</span>
                    </div>
                    <p
                        style="font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 0.75rem; line-height: 1.5;">
                        Weight for impact on <strong>customers, citizens, partners, suppliers, and third-party service
                            providers</strong>.
                        This includes service disruptions, data breaches affecting external parties, or contractual
                        obligations.
                    </p>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem; font-style: italic;">
                        ðŸ’¡ Example: Increase to 3.0x+ for customer-facing services or B2B partnerships with strict SLAs.
                    </p>
                    <input type="range" id="weightExt" min="0" max="4" step="1" value="1" class="w-full form-range"
                        oninput="document.getElementById('valExt').textContent = this.value">
                    <div style="display: flex; justify-content: space-between; margin-top: 0.25rem;">
                        <span style="font-size: 0.7rem; color: var(--text-muted);">Low (0.1x)</span>
                        <span style="font-size: 0.7rem; color: var(--text-muted);">High (5.0x)</span>
                    </div>
                </div>

                <!-- Internal -->
                <div
                    style="background: rgba(255,255,255,0.05); padding: 1.25rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; font-size: 1rem;">Internal Impact</label>
                        <span style="color: var(--accent-primary); font-weight: 700; font-size: 1.125rem;"
                            id="valInt">1.0x</span>
                    </div>
                    <p
                        style="font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 0.75rem; line-height: 1.5;">
                        Weight for <strong>operational disruption, staff productivity loss, and mission-critical
                            functions</strong>.
                        Reflects the impact on internal workflows, employee efficiency, and core business operations.
                    </p>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem; font-style: italic;">
                        ðŸ’¡ Example: Use 2.5x+ if internal operations directly support revenue-generating activities or
                        safety.
                    </p>
                    <input type="range" id="weightInt" min="0" max="4" step="1" value="1" class="w-full form-range"
                        oninput="document.getElementById('valInt').textContent = this.value">
                    <div style="display: flex; justify-content: space-between; margin-top: 0.25rem;">
                        <span style="font-size: 0.7rem; color: var(--text-muted);">Low (0.1x)</span>
                        <span style="font-size: 0.7rem; color: var(--text-muted);">High (5.0x)</span>
                    </div>
                </div>

                <!-- Legal -->
                <div
                    style="background: rgba(255,255,255,0.05); padding: 1.25rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; font-size: 1rem;">Legal Impact</label>
                        <span style="color: var(--accent-primary); font-weight: 700; font-size: 1.125rem;"
                            id="valLeg">1.0x</span>
                    </div>
                    <p
                        style="font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 0.75rem; line-height: 1.5;">
                        Weight for exposure to <strong>legal liability, regulatory fines, compliance violations, and
                            lawsuits</strong>.
                        Includes penalties from data protection laws (GDPR, CCPA), industry regulations, or contractual
                        breaches.
                    </p>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem; font-style: italic;">
                        ðŸ’¡ Example: Set to 4.0x+ if operating in highly regulated industries (finance, healthcare,
                        government).
                    </p>
                    <input type="range" id="weightLeg" min="0" max="4" step="1" value="1" class="w-full form-range"
                        oninput="document.getElementById('valLeg').textContent = this.value">
                    <div style="display: flex; justify-content: space-between; margin-top: 0.25rem;">
                        <span style="font-size: 0.7rem; color: var(--text-muted);">Low (0.1x)</span>
                        <span style="font-size: 0.7rem; color: var(--text-muted);">High (5.0x)</span>
                    </div>
                </div>

                <!-- Economic -->
                <div style="background: rgba(255,255,255,0.05); padding: 1.25rem; border-radius: 0.5rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; font-size: 1rem;">Economic Impact</label>
                        <span style="color: var(--accent-primary); font-weight: 700; font-size: 1.125rem;"
                            id="valEco">1.0x</span>
                    </div>
                    <p
                        style="font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 0.75rem; line-height: 1.5;">
                        Weight for <strong>direct financial loss, lost revenue, recovery costs, and business continuity
                            expenses</strong>.
                        This includes immediate monetary impact, ransom demands, system restoration costs, and lost
                        business opportunities.
                    </p>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem; font-style: italic;">
                        ðŸ’¡ Example: Prioritize with 3.0x+ if downtime directly translates to significant revenue loss.
                    </p>
                    <input type="range" id="weightEco" min="0" max="4" step="1" value="1" class="w-full form-range"
                        oninput="document.getElementById('valEco').textContent = this.value">
                    <div style="display: flex; justify-content: space-between; margin-top: 0.25rem;">
                        <span style="font-size: 0.7rem; color: var(--text-muted);">Low (0.1x)</span>
                        <span style="font-size: 0.7rem; color: var(--text-muted);">High (5.0x)</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save Configuration</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, isAuthenticated, getUser, bia } from '../js/api.js';

        // Safety: Ensure no modals are stuck open on load immediately
        document.querySelectorAll('.modal-backdrop').forEach(el => el.classList.remove('active'));

        // Check authentication
        if (!isAuthenticated()) {
            window.location.href = '../auth/login.html';
        } else {
            const user = getUser();
            if (user.role !== 'admin') {
                alert("Access restricted to Administrators.");
                // Redirect to dashboard
                window.location.href = 'index.html';
            }
        }

        const user = getUser();
        if (user) {
            document.getElementById('userName').textContent = user.first_name ? `${user.first_name} ${user.last_name || ''}` : user.email;
            document.getElementById('userRole').textContent = user.role;
            document.getElementById('userAvatar').textContent = (user.first_name?.[0] || user.email[0]).toUpperCase();
        }

        // Hide admin-only nav links for non-admin users
        if (user.role !== 'admin') {
            document.getElementById('navBia')?.remove();
            document.getElementById('navTeam')?.remove();
        }

        document.getElementById('logoutBtn').addEventListener('click', () => auth.logout());

        // API Helper removed - using bia from api.js

        // State
        let currentProcess = null;

        loadData();

        async function loadData() {
            try {
                // Load Compliance Level
                const levelData = await bia.getComplianceLevel();
                const aggLevelEl = document.getElementById('aggLevel');
                aggLevelEl.textContent = levelData.level;
                aggLevelEl.className = `text-4xl font-bold ${levelData.level === 'High' ? 'text-red-500' : levelData.level === 'Medium' ? 'text-orange-500' : 'text-green-500'}`;
                document.getElementById('aggControls').textContent = `Required Controls: ${levelData.controls}`;

                // Load Processes
                const processes = await bia.getProcesses();
                const grid = document.getElementById('processesGrid');
                grid.innerHTML = processes.length ? processes.map(p => `
                    <div class="glass-card hover:border-primary/50 cursor-pointer transition-colors" onclick="window.editProcess('${p.id}')">
                        <div class="flex justify-between mb-4">
                            <h3 class="font-semibold text-lg">${p.name}</h3>
                            <div class="text-2xl font-bold text-gradient">${p.criticality_score}</div>
                        </div>
                        <p class="text-sm text-secondary mb-4">Owner: ${p.owner || 'Unassigned'}</p>
                        <div class="flex gap-2">
                             <div class="text-xs px-2 py-1 rounded bg-white/5 border border-white/10">
                                ${p.assets.length} Assets
                             </div>
                             ${p.assets.some(a => a.security_level === 'High') ? '<div class="text-xs px-2 py-1 rounded bg-red-500/20 text-red-500 border border-red-500/30">High Value</div>' : ''}
                        </div>
                    </div>
                `).join('') : '<div class="col-span-full text-center py-12 text-secondary">No processes found. Click "Add Process" to start.</div>';

            } catch (err) {
                console.error(err);
                alert('Failed to load BIA data');
            }
        }

        // --- Window bindings for HTML event handlers ---
        window.openSettings = async () => {
            try {
                const settings = await bia.getSettings();

                // Set values for sliders (integer 0-4 per NIA Policy)
                document.getElementById('weightRep').value = settings.w_reputation || 1;
                document.getElementById('weightExt').value = settings.w_external || 1;
                document.getElementById('weightInt').value = settings.w_internal || 1;
                document.getElementById('weightLeg').value = settings.w_legal || 1;
                document.getElementById('weightEco').value = settings.w_economic || 1;

                // Update text displays (no 'x' suffix)
                document.getElementById('valRep').textContent = settings.w_reputation || 1;
                document.getElementById('valExt').textContent = settings.w_external || 1;
                document.getElementById('valInt').textContent = settings.w_internal || 1;
                document.getElementById('valLeg').textContent = settings.w_legal || 1;
                document.getElementById('valEco').textContent = settings.w_economic || 1;

                document.getElementById('settingsModal').classList.add('active');
            } catch (error) {
                alert('Failed to load settings: ' + error.message);
            }
        };

        window.closeSettings = () => document.getElementById('settingsModal').classList.remove('active');

        window.saveSettings = async () => {
            try {
                await bia.updateSettings({
                    weight_reputation: parseFloat(document.getElementById('weightRep').value),
                    weight_external: parseFloat(document.getElementById('weightExt').value),
                    weight_internal: parseFloat(document.getElementById('weightInt').value),
                    weight_legal: parseFloat(document.getElementById('weightLeg').value),
                    weight_economic: parseFloat(document.getElementById('weightEco').value)
                });
                window.closeSettings();
                loadData();
            } catch (e) { alert(e.message); }
        };

        window.openProcessModal = () => {
            currentProcess = null;
            document.getElementById('processId').value = '';
            document.getElementById('processName').value = '';
            document.getElementById('processOwner').value = '';
            document.getElementById('processModalTitle').textContent = 'Add Business Process';
            ['impRep', 'impExt', 'impInt', 'impLeg', 'impEco'].forEach(id => document.getElementById(id).value = '0');
            document.getElementById('criticalityScoreDisplay').textContent = '0';
            document.getElementById('criticalityScoreDisplay').textContent = '0';
            document.getElementById('assetSection').classList.add('hidden');
            document.getElementById('btnDeleteProcess').style.display = 'none'; // Hide delete
            document.getElementById('processModal').classList.add('active');
        };
        window.editProcess = async (id) => {
            const processes = await bia.getProcesses();
            const p = processes.find(proc => proc.id === id);
            if (!p) return;
            currentProcess = p;
            document.getElementById('processId').value = p.id;
            document.getElementById('processName').value = p.name;
            document.getElementById('processOwner').value = p.owner;
            document.getElementById('processModalTitle').textContent = 'Edit Process';

            document.getElementById('impRep').value = p.impact_reputation;
            document.getElementById('impExt').value = p.impact_external;
            document.getElementById('impInt').value = p.impact_internal;
            document.getElementById('impLeg').value = p.impact_legal;
            document.getElementById('impEco').value = p.impact_economic;
            document.getElementById('criticalityScoreDisplay').textContent = p.criticality_score;

            renderAssets(p.assets);
            renderAssets(p.assets);
            document.getElementById('assetSection').classList.remove('hidden');
            document.getElementById('btnDeleteProcess').style.display = 'block'; // Show delete
            document.getElementById('processModal').classList.add('active');
        };
        window.closeProcessModal = () => document.getElementById('processModal').classList.remove('active');

        window.saveProcess = async () => {
            const id = document.getElementById('processId').value;
            const name = document.getElementById('processName').value.trim();
            const owner = document.getElementById('processOwner').value.trim();

            // Validation
            if (!name) {
                alert('Please enter a Process Name');
                return;
            }
            if (!owner) {
                alert('Please enter a Process Owner');
                return;
            }

            const data = {
                name: name,
                owner: owner,
                impact_reputation: parseInt(document.getElementById('impRep').value),
                impact_external: parseInt(document.getElementById('impExt').value),
                impact_internal: parseInt(document.getElementById('impInt').value),
                impact_legal: parseInt(document.getElementById('impLeg').value),
                impact_economic: parseInt(document.getElementById('impEco').value)
            };

            try {
                if (id) {
                    await bia.updateProcess(id, data);
                } else {
                    await bia.createProcess(data);
                }
                window.closeProcessModal();
                loadData();
            } catch (e) { alert(e.message); }
        };

        window.deleteCurrentProcess = async () => {
            if (!currentProcess || !confirm("Permanently delete this process (" + currentProcess.name + ") and all its assets? This action cannot be undone.")) return;
            try {
                await bia.deleteProcess(currentProcess.id);
                window.closeProcessModal();
                loadData();
            } catch (e) { alert(e.message); }
        };

        function renderAssets(assets) {
            const tbody = document.getElementById('assetsTableBody');
            tbody.innerHTML = assets.map(a => `
                <tr class="border-b border-white/5">
                    <td class="py-2">${a.name}</td>
                    <td class="py-2 text-sm text-secondary">${a.type}</td>
                    <td class="py-2 text-sm font-mono">C${a.c_rating} I${a.i_rating} A${a.a_rating}</td>
                    <td class="py-2"><span class="security-badge security-${a.security_level.toLowerCase()}">${a.security_level}</span></td>
                    <td class="py-2">
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button onclick="window.editAsset('${a.id}')" class="text-blue-400 hover:text-blue-300" title="Edit Asset" style="background: none; border: none; cursor: pointer; padding: 0.25rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button onclick="window.deleteAsset('${a.id}')" class="text-red-400 hover:text-red-300" title="Delete Asset" style="background: none; border: none; cursor: pointer; padding: 0.25rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        window.openAssetForm = () => {
            if (!currentProcess) return;
            document.getElementById('assetId').value = '';
            document.getElementById('assetName').value = '';
            document.getElementById('assetType').value = 'Data';
            document.getElementById('ratingC').value = 0; document.getElementById('lblC').textContent = '0 - Public';
            document.getElementById('ratingI').value = 0; document.getElementById('lblI').textContent = '0 - Not Important';
            document.getElementById('ratingA').value = 0; document.getElementById('lblA').textContent = '0 - Not Important';
            document.getElementById('assetModal').classList.add('active');
        };

        window.editAsset = (assetId) => {
            if (!currentProcess) return;
            const asset = currentProcess.assets.find(a => a.id === assetId);
            if (!asset) return;

            document.getElementById('assetId').value = asset.id;
            document.getElementById('assetName').value = asset.name;
            document.getElementById('assetType').value = asset.type;
            document.getElementById('ratingC').value = asset.c_rating;
            document.getElementById('ratingI').value = asset.i_rating;
            document.getElementById('ratingA').value = asset.a_rating;

            // Update labels per NIA Policy definitions
            const cLabels = ['C0 - Public', 'C1 - Internal Use Only', 'C2 - Limited Access', 'C3 - Restricted'];
            const iLabels = ['I0 - Not Important', 'I1 - Identifiable', 'I2 - Checked', 'I3 - Provable'];
            const aLabels = ['A0 - Not Important', 'A1 - 90% Availability', 'A2 - 99% Availability', 'A3 - 99.9% Availability'];

            document.getElementById('lblC').textContent = cLabels[asset.c_rating];
            document.getElementById('lblI').textContent = iLabels[asset.i_rating];
            document.getElementById('lblA').textContent = aLabels[asset.a_rating];

            document.getElementById('assetModal').classList.add('active');
        };

        window.closeAssetModal = () => document.getElementById('assetModal').classList.remove('active');

        window.updateLabel = (id, val) => {
            const labels = {
                'lblI': ['I0 - Not Important', 'I1 - Identifiable', 'I2 - Checked', 'I3 - Provable'],
                'lblA': ['A0 - Not Important', 'A1 - 90% Availability', 'A2 - 99% Availability', 'A3 - 99.9% Availability']
            };
            if (labels[id]) {
                document.getElementById(id).textContent = labels[id][val];
            } else {
                document.getElementById(id).textContent = val;
            }
        };

        window.updateCLabel = (val) => {
            const cLabels = ['C0 - Public', 'C1 - Internal Use Only', 'C2 - Limited Access', 'C3 - Restricted'];
            document.getElementById('lblC').textContent = cLabels[val];
        };

        window.saveAsset = async () => {
            const assetId = document.getElementById('assetId').value;
            const name = document.getElementById('assetName').value.trim();

            if (!name) {
                alert('Please enter an Asset Name');
                return;
            }

            const data = {
                name: name,
                type: document.getElementById('assetType').value,
                process_id: currentProcess.id,
                c_rating: parseInt(document.getElementById('ratingC').value),
                i_rating: parseInt(document.getElementById('ratingI').value),
                a_rating: parseInt(document.getElementById('ratingA').value)
            };

            try {
                if (assetId) {
                    // Update existing asset
                    await bia.updateAsset(assetId, data);
                } else {
                    // Create new asset
                    await bia.createAsset(data);
                }
                window.closeAssetModal();
                // Reload process to get updated assets
                const processes = await bia.getProcesses();
                const p = processes.find(proc => proc.id === currentProcess.id);
                currentProcess = p;
                renderAssets(p.assets);
                loadData(); // To update main cards too
            } catch (e) { alert(e.message); }
        };

        window.deleteAsset = async (id) => {
            if (!confirm('Delete this asset?')) return;
            try {
                await bia.deleteAsset(id);
                const processes = await bia.getProcesses();
                const p = processes.find(proc => proc.id === currentProcess.id);
                currentProcess = p;
                renderAssets(p.assets);
                loadData();
            } catch (e) { alert(e.message); }
        };
    </script>
</body>

</html>